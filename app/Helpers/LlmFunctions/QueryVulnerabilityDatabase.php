<?php

namespace App\Helpers\LlmFunctions;

use App\Models\Alert;
use App\Models\Asset;
use App\User;

class QueryVulnerabilityDatabase extends AbstractLlmFunction
{
    public function html(): string
    {
        $header = "
            <th class='right'>Id</th>
            <th>Actif</th>
            <th>IP</th>
            <th class='right'>Port</th>
            <th>Protocole</th>
            <th>CVE</th>
            <th>Criticit√©</th>
        ";

        $rows = $this->output()
            ->map(function (Alert $alert) {

                $cve = $alert->cve_id ?
                    "<a href='https://nvd.nist.gov/vuln/detail/{$alert->cve_id}' target='_blank'>{$alert->cve_id}</a>" :
                    "n/a";

                if ($alert->level === 'High') {
                    $level = "<span class='lozenge error'>{$alert->level}</span>";
                } else if ($alert->level === 'Medium') {
                    $level = "<span class='lozenge warning'>{$alert->level}</span>";
                } else if ($alert->level === 'Low') {
                    $level = "<span class='lozenge information'>{$alert->level}</span>";
                } else {
                    $level = "<span class='lozenge neutral'>{$alert->level}</span>";
                }
                return "
                    <tr>
                        <td class='right'>{$alert->id}</td>
                        <td>{$alert->asset()?->asset}</td>
                        <td class='right'>{$alert->port()?->ip}</td>
                        <td>{$alert->port()?->port}</td>
                        <td>{$alert->port()?->protocol}</td>
                        <td>{$cve}</td>
                        <td>{$level}</td>
                    </tr>
                ";
            })
            ->join("\n");

        return self::htmlTable($header, $rows, 7);
    }

    public function text(): string
    {
        $output = $this->output();
        return $output->isEmpty() ? 'No vulnerabilities were found.'
            : $output->map(function (Alert $alert) {

                $cve = $alert->cve_id ?
                    "https://nvd.nist.gov/vuln/detail/{$alert->cve_id}" :
                    "n/a";
                $vulnerability = addslashes($alert->vulnerability);
                $remediation = addslashes($alert->remediation);

                return "| {$alert->id} | {$alert->asset()?->asset} | {$alert->port()?->ip} | {$alert->port()?->port} | {$alert->port()?->protocol} | {$cve} | {$alert->level} | {$vulnerability} | {$remediation} |";
            })
            ->prepend("| Id | Asset | IP | Port | Protocol | CVE | Severity | Vulnerability | Remediation |")
            ->prepend("|---|---|---|---|---|---|---|---|---|")
            ->join("\n");
    }

    protected function schema2(): array
    {
        return [
            "type" => "function",
            "function" => [
                "name" => "query_vulnerability_database",
                "description" => "Query the vulnerability database.",
                "parameters" => [
                    "type" => "object",
                    "properties" => [
                        "id" => [
                            "type" => ["integer", "null"],
                            "description" => "The alert's unique identifier.",
                        ],
                        "asset" => [
                            "type" => ["string", "null"],
                            "description" => "The asset's IP address, domain or subdomain.",
                        ],
                        "severity" => [
                            "type" => ["array", "null"],
                            "description" => "The severity levels of the vulnerabilities: High, Medium, or Low.",
                        ],
                    ],
                    "required" => [],
                    "additionalProperties" => false,
                ],
                "strict" => true,
            ],
        ];
    }

    protected function handle2(User $user, string $threadId, array $args): AbstractLlmFunction
    {
        $id = $args['id'] ?? null;
        $asset = $args['asset'] ?? null;
        $severity = $args['severity'] ?? null;
        $query = Asset::where('is_monitored', true);

        if (!empty($asset)) {
            $query->where('asset', $asset);
        }

        $this->output = $query->get()
            ->flatMap(fn(Asset $asset) => $asset->alerts()->get())
            ->filter(fn(Alert $alert) => !isset($id) || $alert->id == $id)
            ->filter(fn(Alert $alert) => $alert->is_hidden === 0)
            ->filter(fn(Alert $alert) => !isset($severity) ||
                !is_array($severity) ||
                count($severity) <= 0 ||
                in_array($alert->level, $severity)
            )
            ->sortBy(function (Alert $item) {
                if ($item->level === 'High') {
                    return 1;
                }
                if ($item->level === 'Medium') {
                    return 2;
                }
                if ($item->level === 'Low') {
                    return 3;
                }
                return 4;
            });

        return $this;
    }
}
